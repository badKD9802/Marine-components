<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영마린테크 관리자</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #003366;
            --primary-dark: #001f3f;
            --primary-light: #e6f2ff;
            --accent: #0099cc;
            --accent-light: #00b8e6;
            --success: #28a745;
            --warning: #ff9800;
            --error: #dc3545;
            --text-dark: #1a1a1a;
            --text-regular: #333333;
            --text-light: #666666;
            --text-muted: #999999;
            --bg-white: #ffffff;
            --bg-gray: #f8f9fa;
            --bg-gray-100: #f1f3f5;
            --border: #e9ecef;
            --border-light: #f0f0f0;
            --gradient: linear-gradient(135deg, #003366 0%, #0099cc 100%);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', 'Segoe UI', sans-serif;
            background: var(--bg-gray);
            color: var(--text-regular);
            min-height: 100vh;
        }

        /* ===== 헤더 ===== */
        .header {
            background: var(--gradient);
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,51,102,0.3);
            position: relative;
            z-index: 10;
        }
        .header h1 { font-size: 1.15rem; font-weight: 600; letter-spacing: -0.3px; }
        .header .logout-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .header .logout-btn:hover { background: rgba(255,255,255,0.25); }

        /* ===== 로그인 ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        }
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 48px 40px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-box h1 { font-size: 1.5rem; color: var(--primary); margin-bottom: 6px; font-weight: 700; }
        .login-box p { color: var(--text-light); font-size: 0.875rem; margin-bottom: 32px; }
        .login-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,153,204,0.1); }
        .login-box .error { color: var(--error); font-size: 0.8rem; margin-bottom: 12px; display: none; }

        /* ===== 버튼 ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 22px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-accent { background: var(--gradient); color: white; }
        .btn-accent:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { background: var(--error); color: white; font-size: 0.78rem; padding: 5px 12px; border-radius: 6px; }
        .btn-danger:hover { background: #c82333; }
        .btn-ghost { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--bg-gray); }
        .btn-sm { font-size: 0.8rem; padding: 7px 16px; }

        /* ===== 대시보드 ===== */
        .dashboard { display: none; }

        /* ===== 탭 네비게이션 ===== */
        .tab-nav {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }
        .tab-nav button {
            background: none;
            border: none;
            padding: 14px 28px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2.5px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
            font-family: inherit;
        }
        .tab-nav button.active { color: var(--primary); border-bottom-color: var(--accent); }
        .tab-nav button:hover { color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content { max-width: 960px; margin: 0 auto; padding: 24px; }

        /* ===== 업로드 영역 ===== */
        .upload-section { display: flex; gap: 16px; margin-bottom: 24px; }
        .upload-card {
            flex: 1;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 14px;
            padding: 28px 20px;
            text-align: center;
            transition: all 0.25s;
            cursor: pointer;
        }
        .upload-card:hover { border-color: var(--accent); background: rgba(0,153,204,0.02); }
        .upload-card.dragover { border-color: var(--accent); background: var(--primary-light); }
        .upload-card .icon { font-size: 2rem; margin-bottom: 8px; }
        .upload-card .title { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
        .upload-card .subtitle { font-size: 0.75rem; color: var(--text-muted); }
        .upload-card input[type="file"] { display: none; }
        .purpose-label {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.68rem;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }
        .purpose-consultant { background: #d4edda; color: #155724; }
        .purpose-rag { background: #cce5ff; color: #004085; }

        /* ===== 업로드 진행 ===== */
        .upload-progress {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        .upload-progress .file-name { font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bar { height: 5px; background: var(--bg-gray-100); border-radius: 3px; overflow: hidden; }
        .progress-bar .fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 3px;
            animation: progress-indeterminate 1.5s infinite;
        }
        @keyframes progress-indeterminate {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* ===== 문서 테이블 ===== */
        .docs-section h2 { font-size: 1.05rem; font-weight: 600; margin-bottom: 14px; color: var(--text-dark); }
        .docs-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .docs-table table { width: 100%; border-collapse: collapse; }
        .docs-table th {
            text-align: left;
            padding: 11px 16px;
            background: var(--bg-gray);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .docs-table td {
            padding: 11px 16px;
            border-top: 1px solid var(--border-light);
            font-size: 0.85rem;
        }
        .docs-table tr:hover td { background: var(--bg-gray); }
        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 500;
        }
        .badge-done { background: #d4edda; color: #155724; }
        .badge-processing { background: #fff3cd; color: #856404; }
        .badge-error { background: #f8d7da; color: #721c24; }
        .badge-pending { background: var(--bg-gray-100); color: var(--text-muted); }
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 2rem; margin-bottom: 8px; }

        /* ===== 모달 ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 28px;
            box-shadow: var(--shadow-lg);
        }
        .modal h3 { font-size: 1.1rem; margin-bottom: 16px; font-weight: 600; }
        .modal .chunk {
            background: var(--bg-gray);
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .modal .chunk-label { font-weight: 600; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 4px; }
        .modal .close-btn {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .modal .close-btn:hover { color: var(--text-dark); }

        /* ============================================
           RAG 채팅 탭 — 모던 3컬럼 레이아웃
           ============================================ */
        .rag-layout {
            display: flex;
            height: calc(100vh - 105px);
            background: var(--bg-gray);
        }

        /* --- 왼쪽 사이드바: 대화 목록 --- */
        .sidebar-conv {
            width: 260px;
            background: white;
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }
        .sidebar-conv-header {
            padding: 16px 16px 12px;
            border-bottom: 1px solid var(--border-light);
        }
        .sidebar-conv-header button { width: 100%; }
        .conv-list { flex: 1; overflow-y: auto; padding: 8px; }
        .conv-list::-webkit-scrollbar { width: 4px; }
        .conv-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .conv-item {
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 3px;
            font-size: 0.84rem;
            color: var(--text-regular);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;
            position: relative;
        }
        .conv-item:hover { background: var(--bg-gray); }
        .conv-item.active { background: var(--primary-light); color: var(--primary); font-weight: 500; }
        .conv-item-icon {
            width: 32px; height: 32px;
            background: var(--bg-gray-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .conv-item.active .conv-item-icon { background: rgba(0,153,204,0.15); }
        .conv-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .conv-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .conv-item:hover .conv-actions { opacity: 1; }
        .conv-act-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.78rem;
            padding: 3px 5px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .conv-act-btn:hover { background: var(--bg-gray-100); }
        .conv-act-btn.del:hover { color: var(--error); background: #fee; }
        .conv-act-btn.edit:hover { color: var(--accent); }
        .conv-act-btn.save:hover { color: var(--warning); }

        /* 대화 그룹 헤더 */
        .conv-group-header {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 14px 6px;
            margin-top: 4px;
        }
        .conv-group-header:first-child { margin-top: 0; }

        /* 저장된 대화 아이콘 표시 */
        .conv-saved-badge {
            font-size: 0.7rem;
            color: var(--warning);
        }

        /* 인라인 이름 편집 */
        .conv-rename-input {
            flex: 1;
            border: 1.5px solid var(--accent);
            border-radius: 6px;
            padding: 3px 8px;
            font-size: 0.82rem;
            font-family: inherit;
            outline: none;
            background: white;
        }

        /* 채팅 헤더 (대화 선택 시 표시) */
        .chat-header-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            background: white;
            border-bottom: 1px solid var(--border-light);
        }
        .chat-header-bar.visible { display: flex; }
        .chat-header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-header-actions { display: flex; gap: 6px; }
        .btn-icon {
            background: var(--bg-gray);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.78rem;
            color: var(--text-light);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
            font-family: inherit;
        }
        .btn-icon:hover { background: var(--bg-gray-100); color: var(--text-dark); border-color: var(--accent); }
        .conv-age {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        /* --- 가운데: 채팅 영역 --- */
        .chat-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-gray);
        }

        /* 채팅 메시지 영역 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 28px 24px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .chat-messages::-webkit-scrollbar { width: 5px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* 빈 상태 — 초기 중앙 화면 */
        .chat-welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-muted);
            padding: 40px 40px 20px;
        }
        .chat-welcome-icon {
            width: 72px; height: 72px;
            background: var(--gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,153,204,0.25);
        }
        .chat-welcome h3 {
            font-size: 1.15rem;
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 8px;
        }
        .chat-welcome p { font-size: 0.85rem; line-height: 1.6; max-width: 320px; }

        /* 초기 화면 문서 칩 */
        .welcome-docs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
            max-width: 480px;
        }
        .welcome-doc-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            background: white;
            border: 1.5px solid var(--border);
            border-radius: 20px;
            font-size: 0.78rem;
            color: var(--text-regular);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .welcome-doc-chip:hover { border-color: var(--accent); background: var(--primary-light); }
        .welcome-doc-chip.selected { border-color: var(--accent); background: rgba(0,153,204,0.1); color: var(--primary); font-weight: 500; }
        .welcome-doc-chip .chip-check { font-size: 0.7rem; }

        /* 초기 화면 입력 박스 */
        .welcome-input-wrap {
            margin-top: 24px;
            width: 100%;
            max-width: 520px;
        }
        .welcome-input-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1.5px solid var(--border);
            border-radius: 14px;
            padding: 6px 6px 6px 18px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-md);
        }
        .welcome-input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1), var(--shadow-md);
        }
        .welcome-input-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-regular);
            background: transparent;
        }
        .welcome-input-box input::placeholder { color: var(--text-muted); }
        .welcome-hint {
            font-size: 0.72rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* 메시지 버블 */
        .msg-row {
            display: flex;
            gap: 10px;
            max-width: 78%;
            animation: msgFadeIn 0.3s ease;
        }
        @keyframes msgFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.assistant { align-self: flex-start; }

        .msg-avatar {
            width: 34px; height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            font-weight: 600;
            margin-top: 2px;
        }
        .msg-row.user .msg-avatar { background: var(--primary); color: white; }
        .msg-row.assistant .msg-avatar { background: var(--gradient); color: white; }

        .msg-content { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        .msg-bubble {
            padding: 12px 16px;
            font-size: 0.88rem;
            line-height: 1.65;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .msg-row.user .msg-bubble {
            background: var(--primary);
            color: white;
            border-radius: 16px 16px 4px 16px;
            box-shadow: 0 2px 8px rgba(0,51,102,0.2);
        }
        .msg-row.assistant .msg-bubble {
            background: white;
            color: var(--text-regular);
            border-radius: 16px 16px 16px 4px;
            box-shadow: var(--shadow-sm);
        }
        .msg-refs-link {
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 0;
            transition: color 0.15s;
        }
        .msg-refs-link:hover { color: var(--primary); text-decoration: underline; }
        .msg-time {
            font-size: 0.68rem;
            color: var(--text-muted);
            padding: 0 2px;
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 14px 18px;
        }
        .typing-indicator span {
            width: 8px; height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.4); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* 입력 영역 */
        .chat-input-wrap {
            padding: 16px 24px 20px;
            background: transparent;
        }
        .chat-input-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1.5px solid var(--border);
            border-radius: 14px;
            padding: 6px 6px 6px 18px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        .chat-input-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-regular);
            background: transparent;
        }
        .chat-input-box input::placeholder { color: var(--text-muted); }
        .chat-input-box input:disabled { opacity: 0.5; }
        .chat-send-btn {
            width: 40px; height: 40px;
            background: var(--gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover { opacity: 0.9; transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

        /* --- 오른쪽 사이드바: 참조 문서 --- */
        .sidebar-ref {
            width: 280px;
            background: white;
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }
        .sidebar-ref-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-ref-header .header-icon {
            width: 24px; height: 24px;
            background: var(--primary-light);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .ref-doc-list {
            overflow-y: auto;
            padding: 10px 12px;
            flex-shrink: 0;
            height: 45%;
        }
        .ref-doc-list::-webkit-scrollbar { width: 4px; }
        .ref-doc-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* 리사이저 핸들 */
        .ref-resizer {
            height: 7px;
            background: var(--border-light);
            cursor: row-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .ref-resizer:hover, .ref-resizer.dragging { background: var(--accent); }
        .ref-resizer::after {
            content: '';
            width: 32px;
            height: 3px;
            border-radius: 2px;
            background: var(--text-muted);
            opacity: 0.4;
        }
        .ref-resizer:hover::after, .ref-resizer.dragging::after { background: white; opacity: 0.9; }

        .ref-doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-regular);
            margin-bottom: 2px;
            transition: background 0.15s;
        }
        .ref-doc-item:hover { background: var(--bg-gray); }
        .ref-doc-item input[type="checkbox"] {
            width: 16px; height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        .ref-doc-item label {
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ref-doc-all { font-weight: 600; color: var(--text-dark); border-bottom: 1px solid var(--border-light); padding-bottom: 10px; margin-bottom: 4px; }

        /* 참조 청크 패널 */
        .ref-chunks-area {
            flex: 1;
            overflow-y: auto;
            padding: 14px 12px;
            min-height: 60px;
        }
        .ref-chunks-area::-webkit-scrollbar { width: 4px; }
        .ref-chunks-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .ref-chunks-title {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        /* 참조 문서 카드 */
        .ref-chunk-card {
            background: var(--bg-gray);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s;
            font-size: 0.76rem;
        }
        .ref-chunk-card:hover { border-color: var(--accent); background: rgba(0,153,204,0.04); }
        .ref-chunk-card .chunk-file {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.74rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ref-chunk-card .chunk-score {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        .score-bar {
            width: 40px; height: 4px;
            background: var(--bg-gray-100);
            border-radius: 2px;
            overflow: hidden;
        }
        .score-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
        }

        /* 참조 문서 팝업 */
        .ref-popup-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(4px);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            padding: 24px;
            animation: refPopFadeIn 0.2s ease;
        }
        .ref-popup-overlay.active { display: flex; }
        @keyframes refPopFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .ref-popup {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 560px;
            max-height: 75vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 16px 48px rgba(0,0,0,0.2);
            animation: refPopSlideUp 0.25s ease;
        }
        @keyframes refPopSlideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ref-popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 18px 22px 14px;
            border-bottom: 1px solid var(--border-light);
        }
        .ref-popup-header .popup-icon {
            width: 36px; height: 36px;
            background: var(--primary-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        .ref-popup-header .popup-info { flex: 1; min-width: 0; }
        .ref-popup-header .popup-filename {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ref-popup-header .popup-score {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ref-popup-header .popup-score .score-bar { width: 60px; }
        .ref-popup-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.15s;
            line-height: 1;
        }
        .ref-popup-close:hover { color: var(--text-dark); background: var(--bg-gray); }
        .ref-popup-body {
            flex: 1;
            overflow-y: auto;
            padding: 18px 22px 22px;
            font-size: 0.85rem;
            line-height: 1.7;
            color: var(--text-regular);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .ref-popup-body::-webkit-scrollbar { width: 5px; }
        .ref-popup-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }


        /* ============================================
           메일 작성 탭
           ============================================ */
        .mail-layout {
            display: flex;
            height: calc(100vh - 105px);
            background: var(--bg-gray);
        }

        /* 왼쪽: 메일 작성 영역 */
        .mail-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        /* 수신 메일 입력 영역 */
        .mail-incoming {
            background: white;
            border-bottom: 1px solid var(--border-light);
            padding: 16px 20px;
            flex-shrink: 0;
        }
        .mail-incoming-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .mail-incoming-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mail-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .mail-controls select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: inherit;
            color: var(--text-regular);
            background: white;
            cursor: pointer;
            outline: none;
        }
        .mail-controls select:focus { border-color: var(--accent); }
        .mail-incoming textarea {
            width: 100%;
            min-height: 120px;
            max-height: 200px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 0.85rem;
            font-family: inherit;
            line-height: 1.6;
            color: var(--text-regular);
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }
        .mail-incoming textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,153,204,0.08); }
        .mail-incoming textarea::placeholder { color: var(--text-muted); }

        /* 분석 결과 */
        .mail-analysis {
            display: none;
            background: var(--primary-light);
            border: 1px solid rgba(0,153,204,0.2);
            border-radius: 10px;
            padding: 12px 14px;
            margin-top: 10px;
            font-size: 0.82rem;
            line-height: 1.6;
            color: var(--primary-dark);
        }
        .mail-analysis.visible { display: block; }
        .mail-analysis-label {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--accent);
            margin-bottom: 4px;
        }

        /* 편집 영역 (분할 뷰) */
        .mail-editor {
            flex: 1;
            display: flex;
            gap: 0;
            overflow: hidden;
        }
        .mail-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .mail-pane + .mail-pane { border-left: 1px solid var(--border-light); }
        .mail-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: white;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }
        .mail-pane-title {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mail-pane-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.68rem;
            font-weight: 600;
        }
        .badge-ko { background: #d4edda; color: #155724; }
        .badge-lang { background: #cce5ff; color: #004085; }
        .mail-pane textarea {
            flex: 1;
            width: 100%;
            border: none;
            padding: 16px;
            font-size: 0.85rem;
            font-family: inherit;
            line-height: 1.7;
            color: var(--text-regular);
            resize: none;
            outline: none;
            background: var(--bg-white);
        }
        .mail-pane textarea:read-only {
            background: var(--bg-gray);
            color: var(--text-light);
        }
        .mail-pane textarea::placeholder { color: var(--text-muted); }

        /* 하단 액션 바 */
        .mail-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: white;
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
        }
        .mail-actions-left { display: flex; gap: 8px; }
        .mail-actions-right { display: flex; gap: 8px; }

        /* 오른쪽: 참조 문서 + 이력 사이드바 */
        .mail-sidebar {
            width: 280px;
            background: white;
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }
        .mail-sidebar-section {
            display: flex;
            flex-direction: column;
        }
        .mail-sidebar-section:first-child {
            flex-shrink: 0;
            max-height: 45%;
        }
        .mail-sidebar-section:last-child {
            flex: 1;
            border-top: 1px solid var(--border-light);
            min-height: 0;
        }
        .mail-sidebar-header {
            padding: 12px 14px;
            font-weight: 600;
            font-size: 0.82rem;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .mail-doc-list {
            overflow-y: auto;
            padding: 8px 10px;
            flex: 1;
        }
        .mail-doc-list::-webkit-scrollbar { width: 4px; }
        .mail-doc-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .mail-history-list {
            overflow-y: auto;
            padding: 8px 10px;
            flex: 1;
        }
        .mail-history-list::-webkit-scrollbar { width: 4px; }
        .mail-history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .mail-history-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 3px;
            transition: all 0.15s;
            position: relative;
        }
        .mail-history-item:hover { background: var(--bg-gray); }
        .mail-history-item.active { background: var(--primary-light); }
        .mail-history-title {
            font-size: 0.8rem;
            color: var(--text-regular);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }
        .mail-history-meta {
            font-size: 0.68rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mail-history-del {
            position: absolute;
            top: 8px; right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 5px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.15s;
        }
        .mail-history-item:hover .mail-history-del { opacity: 1; }
        .mail-history-del:hover { color: var(--error); background: #fee; }

        /* 메일 로딩 오버레이 */
        .mail-loading {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 12px;
        }
        .mail-loading.active { display: flex; }
        .mail-loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mail-loading-text {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Gmail 연동 바 */
        .gmail-bar {
            background: white;
            border-bottom: 1px solid var(--border-light);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .gmail-bar-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .gmail-bar input[type="text"],
        .gmail-bar input[type="password"] {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: inherit;
            outline: none;
            width: 180px;
        }
        .gmail-bar input:focus { border-color: var(--accent); }
        .gmail-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: var(--text-light);
        }
        .gmail-status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .gmail-status-dot.connected { background: #28a745; }
        .gmail-status-dot.disconnected { background: #dc3545; }
        .gmail-auto-settings {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--text-light);
            margin-left: auto;
        }
        .gmail-auto-settings select {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: inherit;
        }
        .gmail-toggle {
            position: relative;
            width: 36px; height: 20px;
            background: var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .gmail-toggle.active { background: #28a745; }
        .gmail-toggle::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .gmail-toggle.active::after { transform: translateX(16px); }

        /* 수신함 탭 전환 */
        .mail-sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }
        .mail-sidebar-tab {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        .mail-sidebar-tab:hover { color: var(--text-dark); background: var(--bg-gray); }
        .mail-sidebar-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .mail-sidebar-tab .tab-count {
            display: inline-block;
            background: var(--accent);
            color: white;
            font-size: 0.65rem;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 4px;
        }

        /* 수신함 아이템 */
        .inbox-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 3px;
            transition: all 0.15s;
            position: relative;
        }
        .inbox-item:hover { background: var(--bg-gray); }
        .inbox-item.active { background: var(--primary-light); }
        .inbox-item-from {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .inbox-item-subject {
            font-size: 0.75rem;
            color: var(--text-regular);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }
        .inbox-item-meta {
            font-size: 0.68rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .badge-status {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .badge-new { background: #cce5ff; color: #004085; }
        .badge-draft-ready { background: #fff3cd; color: #856404; }
        .badge-replied { background: #d4edda; color: #155724; }
        .badge-ignored { background: #e2e3e5; color: #383d41; }

        /* ===== 반응형 ===== */
        @media (max-width: 1024px) {
            .sidebar-ref { display: none; }
            .mail-sidebar { display: none; }
        }
        @media (max-width: 768px) {
            .rag-layout { flex-direction: column; height: auto; min-height: calc(100vh - 105px); }
            .sidebar-conv { width: 100%; max-height: 180px; border-right: none; border-bottom: 1px solid var(--border-light); }
            .upload-section { flex-direction: column; }
            .content { padding: 16px; }
            .mail-layout { flex-direction: column; height: auto; min-height: calc(100vh - 105px); }
            .mail-editor { flex-direction: column; }
            .mail-pane + .mail-pane { border-left: none; border-top: 1px solid var(--border-light); }
        }
    </style>
</head>
<body>
    <!-- ===== 로그인 ===== -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h1>Young Marine Tech</h1>
            <p>관리자 로그인</p>
            <input type="password" id="passwordInput" placeholder="비밀번호를 입력하세요" />
            <div class="error" id="loginError"></div>
            <button class="btn btn-accent" style="width:100%" onclick="handleLogin()">로그인</button>
        </div>
    </div>

    <!-- ===== 대시보드 ===== -->
    <div id="dashboardView" class="dashboard">
        <div class="header">
            <h1>Young Marine Tech 관리자</h1>
            <button class="logout-btn" onclick="handleLogout()">로그아웃</button>
        </div>

        <div class="tab-nav">
            <button class="active" onclick="switchTab('docs')">문서 관리</button>
            <button onclick="switchTab('rag')">RAG 채팅</button>
            <button onclick="switchTab('mail')">메일 작성</button>
        </div>

        <!-- ===== 문서 관리 탭 ===== -->
        <div id="tabDocs" class="tab-content active">
            <div class="content">
                <div class="upload-section">
                    <div class="upload-card" id="uploadConsultant">
                        <input type="file" id="fileInputConsultant" accept=".pdf,.jpg,.jpeg,.png" multiple />
                        <span class="purpose-label purpose-consultant">AI 상담사용</span>
                        <div class="icon">&#128206;</div>
                        <div class="title">AI 상담사 문서 업로드</div>
                        <div class="subtitle">랜딩 페이지 채팅에서 참조</div>
                    </div>
                    <div class="upload-card" id="uploadRag">
                        <input type="file" id="fileInputRag" accept=".pdf,.jpg,.jpeg,.png" multiple />
                        <span class="purpose-label purpose-rag">RAG 세션용</span>
                        <div class="icon">&#128218;</div>
                        <div class="title">RAG 세션 문서 업로드</div>
                        <div class="subtitle">관리자 RAG 채팅에서 참조</div>
                    </div>
                </div>

                <div class="upload-progress" id="uploadProgress">
                    <div class="file-name" id="uploadFileName">업로드 중...</div>
                    <div class="progress-bar"><div class="fill"></div></div>
                </div>

                <div class="docs-section">
                    <h2>업로드된 문서</h2>
                    <div class="docs-table" id="docsTable">
                        <div class="empty-state">
                            <div class="icon">&#128196;</div>
                            <div>아직 업로드된 문서가 없습니다</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== RAG 채팅 탭 ===== -->
        <div id="tabRag" class="tab-content">
            <div class="rag-layout">
                <!-- 왼쪽: 대화 목록 -->
                <div class="sidebar-conv">
                    <div class="sidebar-conv-header">
                        <button class="btn btn-accent btn-sm" style="width:100%" onclick="createConversation()">+ 새 대화</button>
                    </div>
                    <div class="conv-list" id="convList">
                        <div class="empty-state" style="padding:32px 12px;font-size:0.82rem">
                            <div style="font-size:1.3rem;margin-bottom:6px;">&#128172;</div>
                            새 대화를 시작하세요
                        </div>
                    </div>
                </div>

                <!-- 가운데: 채팅 -->
                <div class="chat-center">
                    <div class="chat-header-bar" id="chatHeaderBar">
                        <span class="chat-header-title" id="chatHeaderTitle"></span>
                        <div class="chat-header-actions">
                            <button class="btn-icon" id="chatSaveBtn" onclick="toggleSaveConversation()" title="대화 저장">&#11088; 저장</button>
                            <button class="btn-icon" onclick="startRenameFromHeader()" title="이름 변경">&#9998; 이름 변경</button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-welcome" id="chatWelcome">
                            <div class="chat-welcome-icon">&#9875;</div>
                            <h3>RAG 문서 Q&A</h3>
                            <p>업로드된 기술 문서를 기반으로<br>정확한 답변을 받아보세요</p>
                            <div class="welcome-docs" id="welcomeDocs"></div>
                            <div class="welcome-input-wrap">
                                <div class="welcome-input-box">
                                    <input type="text" id="welcomeInput" placeholder="문서에 대해 질문하세요..." />
                                    <button class="chat-send-btn" id="welcomeSendBtn" onclick="sendRagMessage()">&#10148;</button>
                                </div>
                                <div class="welcome-hint">Enter로 전송 — 대화가 자동 생성됩니다</div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-wrap" id="chatInputWrap" style="display:none">
                        <div class="chat-input-box">
                            <input type="text" id="ragInput" placeholder="문서에 대해 질문하세요..." />
                            <button class="chat-send-btn" id="ragSendBtn" onclick="sendRagMessage()">&#10148;</button>
                        </div>
                    </div>
                </div>

                <!-- 오른쪽: 참조 문서 -->
                <div class="sidebar-ref">
                    <div class="sidebar-ref-header">
                        <span class="header-icon">&#128196;</span>
                        참조 문서
                    </div>
                    <div class="ref-doc-list" id="refDocList">
                        <div class="empty-state" style="padding:20px 12px;font-size:0.8rem">문서 로드 중...</div>
                    </div>
                    <div class="ref-resizer" id="refResizer"></div>
                    <div class="ref-chunks-area" id="refChunksPanel">
                        <div class="ref-chunks-title">&#128269; 참조된 문서 내용</div>
                        <div style="font-size:0.76rem;color:var(--text-muted);text-align:center;padding:12px 0;">질문을 입력하면<br>참조 내용이 표시됩니다</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 메일 작성 탭 ===== -->
        <div id="tabMail" class="tab-content">
            <!-- Gmail 연동 바 -->
            <div class="gmail-bar" id="gmailBar">
                <span class="gmail-bar-title">&#128231; Gmail 연동</span>
                <input type="text" id="gmailEmail" placeholder="이메일 주소" />
                <input type="password" id="gmailAppPassword" placeholder="앱 비밀번호" />
                <button class="btn btn-accent btn-sm" onclick="gmailConnect()">연결</button>
                <button class="btn btn-ghost btn-sm" onclick="gmailDisconnect()" id="gmailDisconnectBtn" style="display:none">연결 해제</button>
                <button class="btn btn-primary btn-sm" onclick="gmailFetch()" id="gmailFetchBtn" style="display:none">&#128229; 메일 가져오기</button>
                <div class="gmail-status" id="gmailStatus">
                    <span class="gmail-status-dot disconnected" id="gmailDot"></span>
                    <span id="gmailStatusText">연결 안됨</span>
                </div>
                <div class="gmail-auto-settings" id="gmailAutoSettings" style="display:none">
                    <span>자동 체크:</span>
                    <select id="gmailCheckTime">
                        <option value="07:00">07:00</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00" selected>09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="12:00">12:00</option>
                        <option value="15:00">15:00</option>
                        <option value="18:00">18:00</option>
                    </select>
                    <div class="gmail-toggle" id="gmailAutoToggle" onclick="toggleGmailAuto()"></div>
                    <span id="gmailLastChecked"></span>
                </div>
            </div>
            <div class="mail-layout">
                <!-- 메인 영역 -->
                <div class="mail-main" style="position:relative">
                    <!-- 수신 메일 입력 -->
                    <div class="mail-incoming">
                        <div class="mail-incoming-header">
                            <h3>&#128233; 수신 메일</h3>
                            <div class="mail-controls">
                                <select id="mailTone">
                                    <option value="formal">격식체</option>
                                    <option value="friendly">친근체</option>
                                    <option value="concise">간결체</option>
                                </select>
                                <button class="btn btn-accent btn-sm" id="mailComposeBtn" onclick="composeMail()">&#9998; 답장 생성</button>
                            </div>
                        </div>
                        <textarea id="mailIncoming" placeholder="수신된 견적/문의 메일 내용을 붙여넣으세요...&#10;&#10;예: Dear Young Marine Tech, We would like to request a quotation for the following spare parts..."></textarea>
                        <div class="mail-analysis" id="mailAnalysis">
                            <div class="mail-analysis-label">&#128269; 메일 분석</div>
                            <div id="mailAnalysisText"></div>
                        </div>
                    </div>

                    <!-- 분할 편집 영역 -->
                    <div class="mail-editor">
                        <div class="mail-pane">
                            <div class="mail-pane-header">
                                <span class="mail-pane-title">&#9998; 한국어 초안 <span class="mail-pane-badge badge-ko">KO</span></span>
                            </div>
                            <textarea id="mailKoreanDraft" placeholder="답장 생성 버튼을 클릭하면 한국어 초안이 여기에 표시됩니다.&#10;수정 후 번역 버튼을 눌러주세요."></textarea>
                        </div>
                        <div class="mail-pane">
                            <div class="mail-pane-header">
                                <span class="mail-pane-title">&#127760; 번역본 <span class="mail-pane-badge badge-lang" id="mailTargetLangBadge">EN</span></span>
                                <select id="mailTargetLang" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:0.75rem;font-family:inherit">
                                    <option value="en">English</option>
                                    <option value="ja">日本語</option>
                                    <option value="zh">中文</option>
                                    <option value="de">Deutsch</option>
                                    <option value="fr">Français</option>
                                    <option value="es">Español</option>
                                </select>
                            </div>
                            <textarea id="mailTranslated" readonly placeholder="한국어 초안을 번역하면 여기에 표시됩니다."></textarea>
                        </div>
                    </div>

                    <!-- 하단 액션 -->
                    <div class="mail-actions">
                        <div class="mail-actions-left">
                            <button class="btn btn-primary btn-sm" id="mailTranslateBtn" onclick="translateMail()" disabled>&#127760; 번역</button>
                            <button class="btn btn-ghost btn-sm" id="mailRetranslateBtn" onclick="translateMail()" disabled>&#128260; 재번역</button>
                        </div>
                        <div class="mail-actions-right">
                            <button class="btn btn-ghost btn-sm" onclick="copyMailDraft('ko')" title="한국어 복사">&#128203; 한국어 복사</button>
                            <button class="btn btn-ghost btn-sm" onclick="copyMailDraft('translated')" title="번역본 복사">&#128203; 번역본 복사</button>
                            <button class="btn btn-primary btn-sm" id="mailSaveBtn" onclick="saveMailComposition()" disabled>&#128190; 저장</button>
                            <button class="btn btn-accent btn-sm" id="mailSendBtn" onclick="sendMailReply()" disabled style="display:none">&#128228; 발송</button>
                        </div>
                    </div>

                    <!-- 로딩 오버레이 -->
                    <div class="mail-loading" id="mailLoading">
                        <div class="mail-loading-spinner"></div>
                        <div class="mail-loading-text" id="mailLoadingText">답장을 생성하고 있습니다...</div>
                    </div>
                </div>

                <!-- 오른쪽 사이드바 -->
                <div class="mail-sidebar">
                    <!-- 탭 전환: 수신함 / 참조문서 / 이력 -->
                    <div class="mail-sidebar-tabs">
                        <button class="mail-sidebar-tab active" onclick="switchMailSidebarTab('inbox')" id="mailSideTabInbox">&#128229; 수신함 <span class="tab-count" id="inboxCount" style="display:none">0</span></button>
                        <button class="mail-sidebar-tab" onclick="switchMailSidebarTab('docs')" id="mailSideTabDocs">&#128196; 문서</button>
                        <button class="mail-sidebar-tab" onclick="switchMailSidebarTab('history')" id="mailSideTabHistory">&#128336; 이력</button>
                    </div>

                    <!-- 수신함 패널 -->
                    <div id="mailSidePanelInbox" style="flex:1;overflow-y:auto;padding:8px 10px;">
                        <div class="empty-state" style="padding:20px 10px;font-size:0.8rem" id="inboxEmpty">Gmail을 연결하면<br>수신 메일이 표시됩니다</div>
                        <div id="inboxList"></div>
                    </div>

                    <!-- 참조 문서 패널 -->
                    <div id="mailSidePanelDocs" style="flex:1;overflow-y:auto;padding:8px 10px;display:none;">
                        <div class="mail-doc-list" id="mailDocList">
                            <div class="empty-state" style="padding:20px 10px;font-size:0.8rem">문서 로드 중...</div>
                        </div>
                    </div>

                    <!-- 이력 패널 -->
                    <div id="mailSidePanelHistory" style="flex:1;overflow-y:auto;padding:8px 10px;display:none;">
                        <div class="mail-history-list" id="mailHistoryList">
                            <div class="empty-state" style="padding:20px 10px;font-size:0.8rem">저장된 이력이 없습니다</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== 문서 상세 모달 ===== -->
    <div class="modal-overlay" id="docModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle">문서 상세</h3>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- ===== 참조 문서 팝업 ===== -->
    <div class="ref-popup-overlay" id="refPopup">
        <div class="ref-popup">
            <div class="ref-popup-header">
                <div class="popup-icon">&#128196;</div>
                <div class="popup-info">
                    <div class="popup-filename" id="refPopupFilename"></div>
                    <div class="popup-score" id="refPopupScore"></div>
                </div>
                <button class="ref-popup-close" onclick="closeRefPopup()">&times;</button>
            </div>
            <div class="ref-popup-body" id="refPopupBody"></div>
        </div>
    </div>

<script>
const API_BASE = 'https://marine-parts-production-60a3.up.railway.app';
let authToken = sessionStorage.getItem('admin_token') || '';
let currentConvId = null;
let ragDocuments = [];

// ============================================================
//  초기화
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    if (authToken) showDashboard();

    document.getElementById('passwordInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') handleLogin();
    });

    setupUploadCard('uploadConsultant', 'fileInputConsultant', 'consultant');
    setupUploadCard('uploadRag', 'fileInputRag', 'rag_session');

    document.getElementById('ragInput').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) sendRagMessage();
    });
    document.getElementById('welcomeInput').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) sendRagMessage();
    });
});

function setupUploadCard(cardId, inputId, purpose) {
    const card = document.getElementById(cardId);
    const input = document.getElementById(inputId);
    card.addEventListener('click', e => { if (e.target.tagName !== 'INPUT') input.click(); });
    card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('dragover'); });
    card.addEventListener('dragleave', () => card.classList.remove('dragover'));
    card.addEventListener('drop', e => { e.preventDefault(); card.classList.remove('dragover'); handleFiles(e.dataTransfer.files, purpose); });
    input.addEventListener('change', e => { handleFiles(e.target.files, purpose); e.target.value = ''; });
}

// ============================================================
//  탭 / 인증
// ============================================================
function switchTab(tab) {
    document.querySelectorAll('.tab-nav button').forEach((btn, i) => {
        btn.classList.toggle('active', (tab === 'docs' && i === 0) || (tab === 'rag' && i === 1) || (tab === 'mail' && i === 2));
    });
    document.getElementById('tabDocs').classList.toggle('active', tab === 'docs');
    document.getElementById('tabRag').classList.toggle('active', tab === 'rag');
    document.getElementById('tabMail').classList.toggle('active', tab === 'mail');
    if (tab === 'rag') { loadConversations(); loadRagDocuments(); }
    if (tab === 'mail') { loadMailDocuments(); loadMailHistory(); loadGmailStatus(); }
}

async function api(path, options = {}) {
    const res = await fetch(API_BASE + path, {
        ...options,
        headers: { ...(options.headers || {}), 'Authorization': 'Bearer ' + authToken },
    });
    if (res.status === 401) { handleLogout(); throw new Error('인증 만료'); }
    return res;
}

async function handleLogin() {
    const pw = document.getElementById('passwordInput').value;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    try {
        const res = await fetch(API_BASE + '/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw }),
        });
        if (!res.ok) { const d = await res.json(); errEl.textContent = d.detail || '로그인 실패'; errEl.style.display = 'block'; return; }
        const d = await res.json();
        authToken = d.token;
        sessionStorage.setItem('admin_token', authToken);
        showDashboard();
    } catch { errEl.textContent = '서버 연결 실패'; errEl.style.display = 'block'; }
}

function handleLogout() {
    authToken = '';
    sessionStorage.removeItem('admin_token');
    document.getElementById('loginView').style.display = 'flex';
    document.getElementById('dashboardView').style.display = 'none';
}

function showDashboard() {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'block';
    loadDocuments();
}

// ============================================================
//  문서 관리 탭
// ============================================================
async function loadDocuments() {
    try { const res = await api('/admin/documents'); renderDocuments(await res.json()); }
    catch (e) { console.error('문서 목록 로드 실패:', e); }
}

function renderDocuments(docs) {
    const c = document.getElementById('docsTable');
    if (!docs.length) { c.innerHTML = '<div class="empty-state"><div class="icon">&#128196;</div><div>아직 업로드된 문서가 없습니다</div></div>'; return; }

    const statusBadge = s => {
        const m = { done: ['badge-done','완료'], processing: ['badge-processing','처리중'], error: ['badge-error','오류'], pending: ['badge-pending','대기'] };
        const [cls, label] = m[s] || ['badge-pending', s];
        return `<span class="badge ${cls}">${label}</span>`;
    };
    const purposeBadge = p => p === 'rag_session'
        ? '<span class="badge purpose-rag" style="margin-left:4px">RAG</span>'
        : '<span class="badge purpose-consultant" style="margin-left:4px">상담</span>';

    let html = '<table><thead><tr><th>파일명</th><th>유형</th><th>용도</th><th>상태</th><th>업로드일</th><th>작업</th></tr></thead><tbody>';
    for (const d of docs) {
        const date = d.created_at ? new Date(d.created_at).toLocaleString('ko-KR') : '-';
        html += `<tr>
            <td style="cursor:pointer;color:var(--accent);font-weight:500" onclick="viewDocument(${d.id})">${d.file_type==='pdf'?'&#128196;':'&#128247;'} ${esc(d.filename)}</td>
            <td>${d.file_type.toUpperCase()}</td>
            <td>${purposeBadge(d.purpose)}</td>
            <td>${statusBadge(d.status)}${d.error_msg?'<br><small style="color:var(--error)">'+esc(d.error_msg)+'</small>':''}</td>
            <td style="font-size:0.8rem;color:var(--text-light)">${date}</td>
            <td><button class="btn btn-danger" onclick="deleteDocument(${d.id})">삭제</button></td>
        </tr>`;
    }
    c.innerHTML = html + '</tbody></table>';
}

async function handleFiles(fileList, purpose) {
    for (const f of fileList) await uploadFile(f, purpose);
}

async function uploadFile(file, purpose) {
    const prog = document.getElementById('uploadProgress');
    const fname = document.getElementById('uploadFileName');
    prog.style.display = 'block';
    fname.textContent = `처리 중: ${file.name}`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('purpose', purpose);
    try {
        const res = await api('/admin/upload', { method: 'POST', body: fd });
        const d = await res.json();
        if (d.status === 'error') { fname.textContent = `오류: ${file.name} — ${d.error_msg}`; setTimeout(() => prog.style.display='none', 4000); }
        else { fname.textContent = `완료: ${file.name} (${d.chunks_count}개 청크)`; setTimeout(() => prog.style.display='none', 2000); }
    } catch { fname.textContent = `업로드 실패: ${file.name}`; setTimeout(() => prog.style.display='none', 4000); }
    loadDocuments();
}

async function viewDocument(docId) {
    try {
        const doc = await (await api(`/admin/documents/${docId}`)).json();
        document.getElementById('modalTitle').textContent = doc.filename;
        let html = `<p style="margin-bottom:12px;color:var(--text-light);font-size:0.85rem">상태: ${doc.status} | 청크: ${doc.chunks.length}개</p>`;
        if (doc.chunks.length) { for (const c of doc.chunks) html += `<div class="chunk-label">청크 #${c.chunk_index+1}</div><div class="chunk">${esc(c.chunk_text)}</div>`; }
        else html += '<p style="color:var(--text-muted)">청크가 없습니다</p>';
        document.getElementById('modalContent').innerHTML = html;
        document.getElementById('docModal').classList.add('active');
    } catch (e) { console.error('문서 상세 조회 실패:', e); }
}

function closeModal() { document.getElementById('docModal').classList.remove('active'); }

async function deleteDocument(docId) {
    if (!confirm('이 문서를 삭제하시겠습니까?')) return;
    try { await api(`/admin/documents/${docId}`, { method: 'DELETE' }); loadDocuments(); }
    catch (e) { console.error('삭제 실패:', e); }
}

// ============================================================
//  RAG 채팅 탭
// ============================================================
async function loadConversations() {
    try { renderConversations(await (await api('/admin/rag/conversations')).json()); }
    catch (e) { console.error('대화 목록 로드 실패:', e); }
}

function renderConversations(convs) {
    const c = document.getElementById('convList');
    if (!convs.length) {
        c.innerHTML = '<div class="empty-state" style="padding:32px 12px;font-size:0.82rem"><div style="font-size:1.3rem;margin-bottom:6px;">&#128172;</div>새 대화를 시작하세요</div>';
        updateChatHeader(null);
        return;
    }

    // 3그룹으로 분류: 저장된 대화, 오늘, 7일 이내
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    const saved = [];
    const today = [];
    const recent = [];

    for (const cv of convs) {
        if (cv.saved) {
            saved.push(cv);
        } else {
            const updated = cv.updated_at ? new Date(cv.updated_at) : new Date();
            if (updated >= todayStart) {
                today.push(cv);
            } else {
                recent.push(cv);
            }
        }
    }

    let html = '';

    const renderGroup = (label, items, showDaysLeft) => {
        if (!items.length) return '';
        let groupHtml = `<div class="conv-group-header">${label}</div>`;
        for (const cv of items) {
            const daysLeft = getDaysLeft(cv.updated_at);
            const savedIcon = cv.saved ? '<span class="conv-saved-badge">&#11088;</span> ' : '';
            const ageText = cv.saved ? '영구 보관' : `${daysLeft}일 후 삭제`;
            groupHtml += `<div class="conv-item ${cv.id===currentConvId?'active':''}" onclick="selectConversation(${cv.id})">
                <div class="conv-item-icon">&#128172;</div>
                <div style="flex:1;min-width:0">
                    <span class="conv-title">${savedIcon}${esc(cv.title)}</span>
                    <div class="conv-age">${ageText}</div>
                </div>
                <div class="conv-actions" onclick="event.stopPropagation()">
                    <button class="conv-act-btn save" onclick="toggleSaveFromList(${cv.id})" title="${cv.saved?'저장 해제':'저장'}">${cv.saved?'&#11088;':'&#9734;'}</button>
                    <button class="conv-act-btn edit" onclick="startRename(${cv.id},'${esc(cv.title).replace(/'/g,"\\&#39;")}')" title="이름 변경">&#9998;</button>
                    <button class="conv-act-btn del" onclick="deleteConversation(${cv.id})" title="삭제">&#10005;</button>
                </div>
            </div>`;
        }
        return groupHtml;
    };

    html += renderGroup('&#11088; 저장한 대화내역', saved, false);
    html += renderGroup('&#128197; 오늘', today, true);
    html += renderGroup('&#128336; 7일 이내', recent, true);

    c.innerHTML = html;
    // 현재 대화 헤더 업데이트
    if (currentConvId) {
        const current = convs.find(cv => cv.id === currentConvId);
        updateChatHeader(current);
    }
}

function getDaysLeft(updatedAt) {
    if (!updatedAt) return 7;
    const updated = new Date(updatedAt);
    const expiry = new Date(updated.getTime() + 7 * 24 * 60 * 60 * 1000);
    const now = new Date();
    const diff = Math.ceil((expiry - now) / (24 * 60 * 60 * 1000));
    return Math.max(0, diff);
}

function updateChatHeader(conv) {
    const bar = document.getElementById('chatHeaderBar');
    const title = document.getElementById('chatHeaderTitle');
    const saveBtn = document.getElementById('chatSaveBtn');
    if (conv) {
        bar.classList.add('visible');
        title.textContent = conv.title;
        if (conv.saved) {
            saveBtn.innerHTML = '&#11088; 저장됨';
            saveBtn.style.color = 'var(--warning)';
            saveBtn.style.borderColor = 'var(--warning)';
        } else {
            saveBtn.innerHTML = '&#9734; 저장';
            saveBtn.style.color = '';
            saveBtn.style.borderColor = '';
        }
    } else {
        bar.classList.remove('visible');
    }
}

async function createConversation() {
    try {
        const cv = await (await api('/admin/rag/conversations', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: '새 대화' }),
        })).json();
        currentConvId = cv.id;
        await loadConversations();
        renderEmptyChat();
        switchToChatMode();
        setChatEnabled(true);
    } catch (e) { console.error('대화 생성 실패:', e); }
}

async function selectConversation(convId) {
    currentConvId = convId;
    await loadConversations();
    await loadConversation(convId);
    switchToChatMode();
    setChatEnabled(true);
}

async function loadConversation(convId) {
    try { renderChatMessages((await (await api(`/admin/rag/conversations/${convId}`)).json()).messages); }
    catch (e) { console.error('대화 로드 실패:', e); }
}

function renderEmptyChat() {
    document.getElementById('chatMessages').innerHTML = `
        <div class="chat-welcome" id="chatWelcome">
            <div class="chat-welcome-icon">&#9875;</div>
            <h3>새 대화가 시작되었습니다</h3>
            <p>오른쪽 패널에서 참조할 문서를 선택하고<br>질문을 입력하세요</p>
        </div>`;
}

function renderChatMessages(messages) {
    const c = document.getElementById('chatMessages');
    if (!messages.length) { renderEmptyChat(); return; }
    let html = '';
    for (const m of messages) {
        const refs = m.references || [];
        const avatar = m.role === 'user' ? 'U' : 'AI';
        html += `<div class="msg-row ${m.role}">
            <div class="msg-avatar">${avatar}</div>
            <div class="msg-content">
                <div class="msg-bubble">${esc(m.content)}</div>
                ${m.role === 'assistant' && refs.length ? `<span class="msg-refs-link" onclick='showRefChunks(${JSON.stringify(refs).replace(/'/g,"&#39;")})'>&#128196; 참조 ${refs.length}건 보기</span>` : ''}
            </div>
        </div>`;
    }
    c.innerHTML = html;
    c.scrollTop = c.scrollHeight;
}

async function deleteConversation(convId) {
    if (!confirm('이 대화를 삭제하시겠습니까?')) return;
    try {
        await api(`/admin/rag/conversations/${convId}`, { method: 'DELETE' });
        if (currentConvId === convId) {
            currentConvId = null;
            showWelcomeScreen();
            updateChatHeader(null);
        }
        loadConversations();
    } catch (e) { console.error('대화 삭제 실패:', e); }
}

// --- 대화 이름 변경 ---
function startRename(convId, currentTitle) {
    const item = document.querySelector(`.conv-item[onclick*="selectConversation(${convId})"]`);
    if (!item) return;
    const titleArea = item.querySelector('.conv-title');
    if (!titleArea) return;

    const input = document.createElement('input');
    input.className = 'conv-rename-input';
    input.value = currentTitle;
    input.onclick = e => e.stopPropagation();

    titleArea.replaceWith(input);
    input.focus();
    input.select();

    const doRename = async () => {
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== currentTitle) {
            try {
                await api(`/admin/rag/conversations/${convId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle }),
                });
            } catch (e) { console.error('이름 변경 실패:', e); }
        }
        loadConversations();
    };

    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); doRename(); }
        if (e.key === 'Escape') loadConversations();
    });
    input.addEventListener('blur', doRename);
}

function startRenameFromHeader() {
    if (!currentConvId) return;
    const title = document.getElementById('chatHeaderTitle').textContent;
    const newTitle = prompt('대화 이름 변경', title);
    if (newTitle && newTitle.trim() && newTitle.trim() !== title) {
        api(`/admin/rag/conversations/${currentConvId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle.trim() }),
        }).then(() => loadConversations()).catch(e => console.error('이름 변경 실패:', e));
    }
}

// --- 대화 저장/해제 토글 ---
async function toggleSaveConversation() {
    if (!currentConvId) return;
    const saveBtn = document.getElementById('chatSaveBtn');
    const origText = saveBtn.innerHTML;
    saveBtn.innerHTML = '&#8987; 처리중...';
    saveBtn.disabled = true;
    try {
        const res = await api(`/admin/rag/conversations/${currentConvId}/save`, { method: 'POST' });
        if (!res.ok) { alert('저장 토글 실패: ' + (await res.json()).detail); return; }
        await loadConversations();
    } catch (e) {
        console.error('저장 토글 실패:', e);
        alert('저장 토글에 실패했습니다.');
        saveBtn.innerHTML = origText;
    } finally {
        saveBtn.disabled = false;
    }
}

async function toggleSaveFromList(convId) {
    try {
        const res = await api(`/admin/rag/conversations/${convId}/save`, { method: 'POST' });
        if (!res.ok) { console.error('저장 토글 실패:', await res.text()); }
        await loadConversations();
    } catch (e) { console.error('저장 토글 실패:', e); }
}

// --- RAG 문서 ---
async function loadRagDocuments() {
    try {
        ragDocuments = await (await api('/admin/rag/documents')).json();
        renderRagDocuments(ragDocuments);
        renderWelcomeDocs(ragDocuments);
    } catch (e) { console.error('RAG 문서 로드 실패:', e); }
}

function renderRagDocuments(docs) {
    const c = document.getElementById('refDocList');
    if (!docs.length) {
        c.innerHTML = '<div class="empty-state" style="padding:24px 12px;font-size:0.8rem"><div style="font-size:1.2rem;margin-bottom:6px;">&#128196;</div>RAG 세션용 문서가 없습니다<br><span style="font-size:0.72rem">문서 관리에서 업로드하세요</span></div>';
        return;
    }
    let html = `<div class="ref-doc-item ref-doc-all"><input type="checkbox" id="refDocAll" checked onchange="toggleAllDocs(this.checked)" /><label for="refDocAll">전체 문서</label></div>`;
    for (const d of docs) {
        html += `<div class="ref-doc-item"><input type="checkbox" class="ref-doc-check" id="refDoc${d.id}" value="${d.id}" checked /><label for="refDoc${d.id}">&#128196; ${esc(d.filename)}</label></div>`;
    }
    c.innerHTML = html;
}

function renderWelcomeDocs(docs) {
    const c = document.getElementById('welcomeDocs');
    if (!c) return;
    if (!docs.length) {
        c.innerHTML = '<div style="font-size:0.78rem;color:var(--text-muted);padding:8px 0;">문서 관리 탭에서 RAG 세션용 문서를 업로드하세요</div>';
        return;
    }
    let html = '';
    for (const d of docs) {
        html += `<div class="welcome-doc-chip selected" data-doc-id="${d.id}" onclick="toggleWelcomeDoc(this)">
            <span class="chip-check">&#10003;</span>
            <span>&#128196; ${esc(d.filename)}</span>
        </div>`;
    }
    c.innerHTML = html;
}

function toggleWelcomeDoc(chip) {
    chip.classList.toggle('selected');
    const check = chip.querySelector('.chip-check');
    check.textContent = chip.classList.contains('selected') ? '\u2713' : '';
    // 사이드바 체크박스도 동기화
    const docId = chip.dataset.docId;
    const sidebarCheck = document.getElementById('refDoc' + docId);
    if (sidebarCheck) sidebarCheck.checked = chip.classList.contains('selected');
    // 전체 체크박스 동기화
    const allCheck = document.getElementById('refDocAll');
    if (allCheck) allCheck.checked = document.querySelectorAll('.welcome-doc-chip.selected').length === ragDocuments.length;
}

function toggleAllDocs(checked) {
    document.querySelectorAll('.ref-doc-check').forEach(cb => cb.checked = checked);
    document.querySelectorAll('.welcome-doc-chip').forEach(chip => {
        if (checked) chip.classList.add('selected');
        else chip.classList.remove('selected');
        chip.querySelector('.chip-check').textContent = checked ? '\u2713' : '';
    });
}

function getSelectedDocIds() {
    // 웰컴 화면의 칩에서도 선택 상태 확인
    const welcomeChips = document.querySelectorAll('.welcome-doc-chip.selected');
    if (welcomeChips.length > 0 && !currentConvId) {
        const ids = Array.from(welcomeChips).map(c => parseInt(c.dataset.docId));
        return (ids.length === ragDocuments.length || ids.length === 0) ? null : ids;
    }
    const ids = Array.from(document.querySelectorAll('.ref-doc-check:checked')).map(cb => parseInt(cb.value));
    return (ids.length === ragDocuments.length || ids.length === 0) ? null : ids;
}

// --- 웰컴 화면 표시/복구 ---
function showWelcomeScreen() {
    document.getElementById('chatInputWrap').style.display = 'none';
    const c = document.getElementById('chatMessages');
    c.innerHTML = `
        <div class="chat-welcome" id="chatWelcome">
            <div class="chat-welcome-icon">&#9875;</div>
            <h3>RAG 문서 Q&A</h3>
            <p>업로드된 기술 문서를 기반으로<br>정확한 답변을 받아보세요</p>
            <div class="welcome-docs" id="welcomeDocs"></div>
            <div class="welcome-input-wrap">
                <div class="welcome-input-box">
                    <input type="text" id="welcomeInput" placeholder="문서에 대해 질문하세요..." />
                    <button class="chat-send-btn" id="welcomeSendBtn" onclick="sendRagMessage()">&#10148;</button>
                </div>
                <div class="welcome-hint">Enter로 전송 — 대화가 자동 생성됩니다</div>
            </div>
        </div>`;
    // 이벤트 리스너 재등록
    document.getElementById('welcomeInput').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) sendRagMessage();
    });
    // 문서 칩 렌더링
    renderWelcomeDocs(ragDocuments);
}

// --- 메시지 전송 ---
async function sendRagMessage() {
    // 웰컴 입력 또는 하단 입력에서 메시지 가져오기
    const welcomeInput = document.getElementById('welcomeInput');
    const ragInput = document.getElementById('ragInput');
    const isFromWelcome = !currentConvId && welcomeInput && welcomeInput.value.trim();
    const input = isFromWelcome ? welcomeInput : ragInput;
    const msg = input.value.trim();
    if (!msg) return;

    input.value = '';

    // 대화가 없으면 자동 생성
    if (!currentConvId) {
        try {
            const cv = await (await api('/admin/rag/conversations', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: '새 대화' }),
            })).json();
            currentConvId = cv.id;
        } catch (e) {
            console.error('대화 자동 생성 실패:', e);
            alert('대화 생성에 실패했습니다.');
            return;
        }
    }

    // 웰컴 화면 → 채팅 모드로 전환
    switchToChatMode();
    setChatEnabled(false);

    appendMsg('user', msg);
    const loadingId = showTyping();

    try {
        const data = await (await api('/admin/rag/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversation_id: currentConvId, message: msg, document_ids: getSelectedDocIds() }),
        })).json();

        removeEl(loadingId);
        appendMsg('assistant', data.reply, data.references || []);
        showRefChunks(data.references || []);
        await loadConversations();
    } catch (e) {
        removeEl(loadingId);
        appendMsg('assistant', '오류가 발생했습니다. 다시 시도해주세요.');
        console.error('RAG 채팅 오류:', e);
    } finally {
        setChatEnabled(true);
    }
}

// 웰컴 화면 → 채팅 모드 전환
function switchToChatMode() {
    const welcome = document.getElementById('chatWelcome');
    if (welcome) welcome.remove();
    document.getElementById('chatInputWrap').style.display = '';
}

let _mc = 0;
function appendMsg(role, content, refs) {
    const c = document.getElementById('chatMessages');
    const welcome = c.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    const id = 'msg-' + (++_mc);
    const avatar = role === 'user' ? 'U' : 'AI';
    const refsHtml = (role === 'assistant' && refs && refs.length)
        ? `<span class="msg-refs-link" onclick='showRefChunks(${JSON.stringify(refs).replace(/'/g,"&#39;")})'>&#128196; 참조 ${refs.length}건 보기</span>` : '';

    const div = document.createElement('div');
    div.className = `msg-row ${role}`;
    div.id = id;
    div.innerHTML = `<div class="msg-avatar">${avatar}</div><div class="msg-content"><div class="msg-bubble">${esc(content)}</div>${refsHtml}</div>`;
    c.appendChild(div);
    c.scrollTop = c.scrollHeight;
    return id;
}

function showTyping() {
    const c = document.getElementById('chatMessages');
    const id = 'typing-' + (++_mc);
    const div = document.createElement('div');
    div.className = 'msg-row assistant';
    div.id = id;
    div.innerHTML = `<div class="msg-avatar">AI</div><div class="msg-content"><div class="msg-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
    c.appendChild(div);
    c.scrollTop = c.scrollHeight;
    return id;
}

function removeEl(id) { const el = document.getElementById(id); if (el) el.remove(); }

let _lastRefs = [];

function showRefChunks(refs) {
    _lastRefs = refs || [];
    const p = document.getElementById('refChunksPanel');
    if (!refs || !refs.length) {
        p.innerHTML = `<div class="ref-chunks-title">&#128269; 참조된 문서 내용</div><div style="font-size:0.76rem;color:var(--text-muted);text-align:center;padding:12px 0;">참조된 내용이 없습니다</div>`;
        return;
    }
    let html = `<div class="ref-chunks-title">&#128269; 참조된 문서 내용 (${refs.length}건)</div>`;
    refs.forEach((r, i) => {
        const pct = Math.round(r.similarity * 100);
        html += `<div class="ref-chunk-card" onclick="openRefPopup(${i})">
            <span class="chunk-file">&#128196; ${esc(r.filename)}</span>
            <span class="chunk-score">${pct}% <span class="score-bar"><span class="score-bar-fill" style="width:${pct}%"></span></span></span>
        </div>`;
    });
    p.innerHTML = html;
}

function openRefPopup(idx) {
    const r = _lastRefs[idx];
    if (!r) return;
    const pct = Math.round(r.similarity * 100);
    document.getElementById('refPopupFilename').textContent = r.filename;
    document.getElementById('refPopupScore').innerHTML = `유사도 ${pct}% <span class="score-bar"><span class="score-bar-fill" style="width:${pct}%"></span></span>`;
    document.getElementById('refPopupBody').textContent = r.chunk_text;
    document.getElementById('refPopup').classList.add('active');
}

function closeRefPopup() {
    document.getElementById('refPopup').classList.remove('active');
}

function setChatEnabled(enabled) {
    const ragInput = document.getElementById('ragInput');
    const ragSendBtn = document.getElementById('ragSendBtn');
    ragInput.disabled = !enabled;
    ragSendBtn.disabled = !enabled;
    if (enabled) ragInput.focus();
}

// ============================================================
//  유틸
// ============================================================
function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

document.getElementById('docModal').addEventListener('click', e => {
    if (e.target === document.getElementById('docModal')) closeModal();
});
document.getElementById('refPopup').addEventListener('click', e => {
    if (e.target === document.getElementById('refPopup')) closeRefPopup();
});

// --- 사이드바 리사이저 ---
(function() {
    const resizer = document.getElementById('refResizer');
    const docList = document.getElementById('refDocList');
    const sidebar = docList.closest('.sidebar-ref');
    let startY, startH;

    resizer.addEventListener('mousedown', e => {
        e.preventDefault();
        startY = e.clientY;
        startH = docList.offsetHeight;
        resizer.classList.add('dragging');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    resizer.addEventListener('touchstart', e => {
        startY = e.touches[0].clientY;
        startH = docList.offsetHeight;
        resizer.classList.add('dragging');
        document.addEventListener('touchmove', onTouchMove);
        document.addEventListener('touchend', onTouchEnd);
    }, { passive: true });

    function onMouseMove(e) { resize(e.clientY); }
    function onTouchMove(e) { resize(e.touches[0].clientY); }

    function resize(currentY) {
        const delta = currentY - startY;
        const sidebarH = sidebar.offsetHeight;
        const headerH = sidebar.querySelector('.sidebar-ref-header').offsetHeight;
        const resizerH = resizer.offsetHeight;
        const minDoc = 60;
        const minChunks = 60;
        const maxDoc = sidebarH - headerH - resizerH - minChunks;
        const newH = Math.max(minDoc, Math.min(maxDoc, startH + delta));
        docList.style.height = newH + 'px';
    }

    function onMouseUp() {
        resizer.classList.remove('dragging');
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
    function onTouchEnd() {
        resizer.classList.remove('dragging');
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);
    }
})();

// ============================================================
//  메일 작성 탭
// ============================================================
let mailDocuments = [];
let mailDetectedLang = 'en';
let mailCurrentRefs = [];

// --- 문서 목록 로드 ---
async function loadMailDocuments() {
    try {
        mailDocuments = await (await api('/admin/rag/documents')).json();
        renderMailDocuments(mailDocuments);
    } catch (e) { console.error('메일 문서 로드 실패:', e); }
}

function renderMailDocuments(docs) {
    const c = document.getElementById('mailDocList');
    if (!docs.length) {
        c.innerHTML = '<div class="empty-state" style="padding:20px 10px;font-size:0.8rem"><div style="font-size:1.2rem;margin-bottom:6px;">&#128196;</div>RAG 세션용 문서가 없습니다<br><span style="font-size:0.72rem">문서 관리에서 업로드하세요</span></div>';
        return;
    }
    let html = `<div class="ref-doc-item ref-doc-all"><input type="checkbox" id="mailDocAll" checked onchange="toggleAllMailDocs(this.checked)" /><label for="mailDocAll">전체 문서</label></div>`;
    for (const d of docs) {
        html += `<div class="ref-doc-item"><input type="checkbox" class="mail-doc-check" id="mailDoc${d.id}" value="${d.id}" checked /><label for="mailDoc${d.id}">&#128196; ${esc(d.filename)}</label></div>`;
    }
    c.innerHTML = html;
}

function toggleAllMailDocs(checked) {
    document.querySelectorAll('.mail-doc-check').forEach(cb => cb.checked = checked);
}

function getMailSelectedDocIds() {
    const ids = Array.from(document.querySelectorAll('.mail-doc-check:checked')).map(cb => parseInt(cb.value));
    return (ids.length === mailDocuments.length || ids.length === 0) ? null : ids;
}

// --- 이력 로드 ---
async function loadMailHistory() {
    try {
        const items = await (await api('/admin/mail/history')).json();
        renderMailHistory(items);
    } catch (e) { console.error('메일 이력 로드 실패:', e); }
}

function renderMailHistory(items) {
    const c = document.getElementById('mailHistoryList');
    if (!items.length) {
        c.innerHTML = '<div class="empty-state" style="padding:20px 10px;font-size:0.8rem">저장된 이력이 없습니다</div>';
        return;
    }
    const langMap = { en: 'EN', ja: 'JA', zh: 'ZH', ko: 'KO', de: 'DE', fr: 'FR', es: 'ES' };
    let html = '';
    for (const item of items) {
        const date = item.created_at ? new Date(item.created_at).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        const lang = langMap[item.detected_lang] || item.detected_lang;
        html += `<div class="mail-history-item" onclick="loadMailHistoryItem(${item.id})">
            <div class="mail-history-title">${esc(item.incoming_email)}</div>
            <div class="mail-history-meta">
                <span class="mail-pane-badge badge-lang">${lang}</span>
                <span>${date}</span>
            </div>
            <button class="mail-history-del" onclick="event.stopPropagation();deleteMailHistory(${item.id})" title="삭제">&#10005;</button>
        </div>`;
    }
    c.innerHTML = html;
}

// --- 답장 생성 ---
async function composeMail() {
    const incoming = document.getElementById('mailIncoming').value.trim();
    if (!incoming) { alert('수신 메일 내용을 입력해주세요.'); return; }

    const tone = document.getElementById('mailTone').value;
    const docIds = getMailSelectedDocIds();

    showMailLoading('수신 메일을 분석하고 답장을 생성하고 있습니다...');

    try {
        const data = await (await api('/admin/mail/compose', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ incoming_email: incoming, document_ids: docIds, tone: tone }),
        })).json();

        mailDetectedLang = data.detected_lang || 'en';
        mailCurrentRefs = data.references || [];

        // 분석 결과 표시
        const analysisEl = document.getElementById('mailAnalysis');
        if (data.analysis) {
            document.getElementById('mailAnalysisText').textContent = data.analysis;
            analysisEl.classList.add('visible');
        } else {
            analysisEl.classList.remove('visible');
        }

        // 한국어 초안
        document.getElementById('mailKoreanDraft').value = data.korean_draft || '';

        // 번역 대상 언어 자동 설정
        const langSelect = document.getElementById('mailTargetLang');
        if (mailDetectedLang && mailDetectedLang !== 'ko') {
            langSelect.value = mailDetectedLang;
        }
        updateTargetLangBadge();

        // 번역본 초기화
        document.getElementById('mailTranslated').value = '';

        // 버튼 활성화
        document.getElementById('mailTranslateBtn').disabled = false;
        document.getElementById('mailSaveBtn').disabled = false;

    } catch (e) {
        console.error('메일 생성 오류:', e);
        alert('메일 생성에 실패했습니다. 다시 시도해주세요.');
    } finally {
        hideMailLoading();
    }
}

// --- 번역 ---
async function translateMail() {
    const koreanText = document.getElementById('mailKoreanDraft').value.trim();
    if (!koreanText) { alert('번역할 한국어 초안이 없습니다.'); return; }

    const targetLang = document.getElementById('mailTargetLang').value;

    showMailLoading('번역 중...');

    try {
        const data = await (await api('/admin/mail/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ korean_text: koreanText, target_lang: targetLang }),
        })).json();

        document.getElementById('mailTranslated').value = data.translated || '';
        document.getElementById('mailRetranslateBtn').disabled = false;
        updateTargetLangBadge();

    } catch (e) {
        console.error('번역 오류:', e);
        alert('번역에 실패했습니다. 다시 시도해주세요.');
    } finally {
        hideMailLoading();
    }
}

// --- 저장 ---
async function saveMailComposition() {
    const incoming = document.getElementById('mailIncoming').value.trim();
    const korean = document.getElementById('mailKoreanDraft').value.trim();
    const translated = document.getElementById('mailTranslated').value.trim();

    if (!incoming || !korean) { alert('수신 메일과 한국어 초안이 필요합니다.'); return; }

    try {
        const saveResp = await (await api('/admin/mail/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                incoming_email: incoming,
                detected_lang: mailDetectedLang,
                tone: document.getElementById('mailTone').value,
                korean_draft: korean,
                translated_draft: translated,
                document_ids: getMailSelectedDocIds(),
                refs: mailCurrentRefs,
            }),
        })).json();

        // 수신 메일이 선택된 상태면 composition_id 연결
        if (currentInboxId && saveResp.id) {
            try {
                await api(`/admin/mail/gmail/inbox/${currentInboxId}/link?composition_id=${saveResp.id}`, { method: 'POST' });
                document.getElementById('mailSendBtn').disabled = false;
                loadInboxEmails();
            } catch (e) { console.error('초안 연결 실패:', e); }
        }

        alert('저장되었습니다.');
        loadMailHistory();
    } catch (e) {
        console.error('저장 오류:', e);
        alert('저장에 실패했습니다.');
    }
}

// --- 이력 불러오기 ---
async function loadMailHistoryItem(id) {
    try {
        const data = await (await api(`/admin/mail/history/${id}`)).json();

        document.getElementById('mailIncoming').value = data.incoming_email || '';
        document.getElementById('mailKoreanDraft').value = data.korean_draft || '';
        document.getElementById('mailTranslated').value = data.translated_draft || '';
        document.getElementById('mailTone').value = data.tone || 'formal';

        mailDetectedLang = data.detected_lang || 'en';
        mailCurrentRefs = data.refs || [];

        if (data.detected_lang && data.detected_lang !== 'ko') {
            document.getElementById('mailTargetLang').value = data.detected_lang;
        }
        updateTargetLangBadge();

        // 분석 숨기기 (이력에서는 분석 없음)
        document.getElementById('mailAnalysis').classList.remove('visible');

        // 버튼 활성화
        document.getElementById('mailTranslateBtn').disabled = false;
        document.getElementById('mailRetranslateBtn').disabled = !(data.translated_draft);
        document.getElementById('mailSaveBtn').disabled = false;

        // 활성 표시
        document.querySelectorAll('.mail-history-item').forEach(el => el.classList.remove('active'));
        const clicked = document.querySelector(`.mail-history-item[onclick*="loadMailHistoryItem(${id})"]`);
        if (clicked) clicked.classList.add('active');

    } catch (e) {
        console.error('이력 로드 실패:', e);
        alert('이력을 불러오는데 실패했습니다.');
    }
}

// --- 이력 삭제 ---
async function deleteMailHistory(id) {
    if (!confirm('이 이력을 삭제하시겠습니까?')) return;
    try {
        await api(`/admin/mail/history/${id}`, { method: 'DELETE' });
        loadMailHistory();
    } catch (e) { console.error('이력 삭제 실패:', e); }
}

// --- 복사 ---
function copyMailDraft(type) {
    const text = type === 'ko'
        ? document.getElementById('mailKoreanDraft').value
        : document.getElementById('mailTranslated').value;
    if (!text) { alert('복사할 내용이 없습니다.'); return; }
    navigator.clipboard.writeText(text).then(() => {
        const label = type === 'ko' ? '한국어 초안' : '번역본';
        alert(`${label}이 클립보드에 복사되었습니다.`);
    }).catch(() => {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('클립보드에 복사되었습니다.');
    });
}

// --- 언어 뱃지 업데이트 ---
function updateTargetLangBadge() {
    const langSelect = document.getElementById('mailTargetLang');
    const badge = document.getElementById('mailTargetLangBadge');
    const langMap = { en: 'EN', ja: 'JA', zh: 'ZH', ko: 'KO', de: 'DE', fr: 'FR', es: 'ES' };
    badge.textContent = langMap[langSelect.value] || langSelect.value.toUpperCase();
}

// 언어 선택 변경 시 뱃지 업데이트
document.getElementById('mailTargetLang').addEventListener('change', updateTargetLangBadge);

// --- 로딩 표시 ---
function showMailLoading(text) {
    document.getElementById('mailLoadingText').textContent = text || '처리 중...';
    document.getElementById('mailLoading').classList.add('active');
    document.getElementById('mailComposeBtn').disabled = true;
    document.getElementById('mailTranslateBtn').disabled = true;
}

function hideMailLoading() {
    document.getElementById('mailLoading').classList.remove('active');
    document.getElementById('mailComposeBtn').disabled = false;
}

// ============================================================
//  Gmail 연동
// ============================================================
let gmailConnected = false;
let currentInboxId = null;  // 현재 선택된 수신 메일 ID

// --- Gmail 상태 로드 ---
async function loadGmailStatus() {
    try {
        const data = await (await api('/admin/mail/gmail/status')).json();
        gmailConnected = data.connected;
        updateGmailUI(data);
    } catch (e) {
        console.error('Gmail 상태 로드 실패:', e);
    }
}

function updateGmailUI(data) {
    const dot = document.getElementById('gmailDot');
    const statusText = document.getElementById('gmailStatusText');
    const disconnectBtn = document.getElementById('gmailDisconnectBtn');
    const fetchBtn = document.getElementById('gmailFetchBtn');
    const autoSettings = document.getElementById('gmailAutoSettings');
    const emailInput = document.getElementById('gmailEmail');
    const pwInput = document.getElementById('gmailAppPassword');
    const sendBtn = document.getElementById('mailSendBtn');

    if (data.connected) {
        dot.className = 'gmail-status-dot connected';
        statusText.textContent = data.email;
        disconnectBtn.style.display = '';
        fetchBtn.style.display = '';
        autoSettings.style.display = '';
        emailInput.value = data.email;
        emailInput.disabled = true;
        pwInput.style.display = 'none';
        sendBtn.style.display = '';

        // 자동 체크 설정
        document.getElementById('gmailCheckTime').value = data.check_time || '09:00';
        const toggle = document.getElementById('gmailAutoToggle');
        if (data.auto_reply_enabled) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }

        // 마지막 체크 시간
        if (data.last_checked_at) {
            const d = new Date(data.last_checked_at);
            document.getElementById('gmailLastChecked').textContent =
                '마지막: ' + d.toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        loadInboxEmails();
    } else {
        dot.className = 'gmail-status-dot disconnected';
        statusText.textContent = '연결 안됨';
        disconnectBtn.style.display = 'none';
        fetchBtn.style.display = 'none';
        autoSettings.style.display = 'none';
        emailInput.disabled = false;
        emailInput.value = '';
        pwInput.style.display = '';
        pwInput.value = '';
        sendBtn.style.display = 'none';
    }
}

// --- Gmail 연결 ---
async function gmailConnect() {
    const email = document.getElementById('gmailEmail').value.trim();
    const pw = document.getElementById('gmailAppPassword').value.trim();
    if (!email || !pw) { alert('이메일과 앱 비밀번호를 입력하세요.'); return; }

    try {
        const resp = await api('/admin/mail/gmail/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, app_password: pw }),
        });
        const data = await resp.json();
        if (!resp.ok) { alert(data.detail || '연결 실패'); return; }
        alert('Gmail 연결 성공!');
        loadGmailStatus();
    } catch (e) {
        alert('Gmail 연결 오류: ' + e.message);
    }
}

// --- Gmail 연결 해제 ---
async function gmailDisconnect() {
    if (!confirm('Gmail 연결을 해제하시겠습니까?')) return;
    try {
        await api('/admin/mail/gmail/disconnect', { method: 'POST' });
        gmailConnected = false;
        currentInboxId = null;
        loadGmailStatus();
    } catch (e) { alert('연결 해제 실패: ' + e.message); }
}

// --- 수동 메일 가져오기 ---
async function gmailFetch() {
    showMailLoading('메일을 가져오는 중...');
    try {
        const data = await (await api('/admin/mail/gmail/fetch', { method: 'POST' })).json();
        alert(data.message);
        loadInboxEmails();
        loadGmailStatus();
    } catch (e) {
        alert('메일 가져오기 실패: ' + e.message);
    } finally {
        hideMailLoading();
    }
}

// --- 자동 체크 토글 ---
async function toggleGmailAuto() {
    const toggle = document.getElementById('gmailAutoToggle');
    const newState = !toggle.classList.contains('active');
    const checkTime = document.getElementById('gmailCheckTime').value;

    try {
        await api('/admin/mail/gmail/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ check_time: checkTime, auto_reply_enabled: newState }),
        });
        toggle.classList.toggle('active', newState);
    } catch (e) { alert('설정 저장 실패: ' + e.message); }
}

// 체크 시간 변경 시 자동 저장
document.getElementById('gmailCheckTime').addEventListener('change', async function () {
    const toggle = document.getElementById('gmailAutoToggle');
    const autoEnabled = toggle.classList.contains('active');
    if (!gmailConnected) return;
    try {
        await api('/admin/mail/gmail/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ check_time: this.value, auto_reply_enabled: autoEnabled }),
        });
    } catch (e) { console.error('설정 저장 실패:', e); }
});

// --- 수신함 로드 ---
async function loadInboxEmails() {
    if (!gmailConnected) return;
    try {
        const items = await (await api('/admin/mail/gmail/inbox')).json();
        renderInboxList(items);
    } catch (e) { console.error('수신함 로드 실패:', e); }
}

function renderInboxList(items) {
    const c = document.getElementById('inboxList');
    const empty = document.getElementById('inboxEmpty');
    const countBadge = document.getElementById('inboxCount');

    if (!items.length) {
        c.innerHTML = '';
        empty.style.display = '';
        countBadge.style.display = 'none';
        return;
    }
    empty.style.display = 'none';

    // new 카운트
    const newCount = items.filter(i => i.status === 'new').length;
    if (newCount > 0) {
        countBadge.textContent = newCount;
        countBadge.style.display = '';
    } else {
        countBadge.style.display = 'none';
    }

    const statusMap = {
        'new': { label: 'NEW', cls: 'badge-new' },
        'draft_ready': { label: '초안', cls: 'badge-draft-ready' },
        'replied': { label: '답장', cls: 'badge-replied' },
        'ignored': { label: '무시', cls: 'badge-ignored' },
    };

    let html = '';
    for (const item of items) {
        const st = statusMap[item.status] || { label: item.status, cls: '' };
        const date = item.received_at ? new Date(item.received_at).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        html += `<div class="inbox-item${currentInboxId === item.id ? ' active' : ''}" onclick="loadInboxItem(${item.id})">
            <div class="inbox-item-from">${esc(item.from_name || item.from_addr)}</div>
            <div class="inbox-item-subject">${esc(item.subject || '(제목 없음)')}</div>
            <div class="inbox-item-meta">
                <span class="badge-status ${st.cls}">${st.label}</span>
                <span>${date}</span>
            </div>
        </div>`;
    }
    c.innerHTML = html;
}

// --- 수신 메일 클릭 → 본문 채우기 ---
async function loadInboxItem(id) {
    try {
        const data = await (await api(`/admin/mail/gmail/inbox/${id}`)).json();
        currentInboxId = id;

        // 수신 메일 textarea에 채우기
        const bodyText = `From: ${data.from_name || ''} <${data.from_addr}>\nSubject: ${data.subject || ''}\n\n${data.body || ''}`;
        document.getElementById('mailIncoming').value = bodyText;

        // 초안이 있으면 채우기
        if (data.draft) {
            document.getElementById('mailKoreanDraft').value = data.draft.korean_draft || '';
            document.getElementById('mailTranslated').value = data.draft.translated_draft || '';
            mailDetectedLang = data.draft.detected_lang || 'en';
            if (data.draft.detected_lang && data.draft.detected_lang !== 'ko') {
                document.getElementById('mailTargetLang').value = data.draft.detected_lang;
            }
            updateTargetLangBadge();
            document.getElementById('mailTranslateBtn').disabled = false;
            document.getElementById('mailRetranslateBtn').disabled = !(data.draft.translated_draft);
            document.getElementById('mailSaveBtn').disabled = false;
        } else {
            document.getElementById('mailKoreanDraft').value = '';
            document.getElementById('mailTranslated').value = '';
        }

        // 분석 숨기기
        document.getElementById('mailAnalysis').classList.remove('visible');

        // 발송 버튼 활성화 (번역본이 있을 때)
        const sendBtn = document.getElementById('mailSendBtn');
        if (data.draft && (data.draft.translated_draft || data.draft.korean_draft)) {
            sendBtn.disabled = false;
        } else {
            sendBtn.disabled = true;
        }

        // 활성 표시
        document.querySelectorAll('.inbox-item').forEach(el => el.classList.remove('active'));
        const clicked = document.querySelector(`.inbox-item[onclick*="loadInboxItem(${id})"]`);
        if (clicked) clicked.classList.add('active');

    } catch (e) {
        console.error('수신 메일 로드 실패:', e);
        alert('수신 메일을 불러오는데 실패했습니다.');
    }
}

// --- 답장 발송 ---
async function sendMailReply() {
    if (!currentInboxId) { alert('발송할 수신 메일을 선택하세요.'); return; }

    const translated = document.getElementById('mailTranslated').value.trim();
    const korean = document.getElementById('mailKoreanDraft').value.trim();
    if (!translated && !korean) { alert('발송할 답장 내용이 없습니다.'); return; }

    if (!confirm('이 답장을 발송하시겠습니까?')) return;

    // 먼저 저장 (composition_id 연결을 위해)
    const incoming = document.getElementById('mailIncoming').value.trim();
    if (incoming && korean) {
        try {
            const saveResp = await (await api('/admin/mail/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    incoming_email: incoming,
                    detected_lang: mailDetectedLang,
                    tone: document.getElementById('mailTone').value,
                    korean_draft: korean,
                    translated_draft: translated,
                    document_ids: getMailSelectedDocIds(),
                    refs: mailCurrentRefs,
                }),
            })).json();

            // inbox_emails에 composition_id 연결
            await api(`/admin/mail/gmail/inbox/${currentInboxId}/link?composition_id=${saveResp.id}`, {
                method: 'POST',
            });
        } catch (e) {
            console.error('저장/연결 오류:', e);
        }
    }

    showMailLoading('메일을 발송하는 중...');
    try {
        const resp = await api(`/admin/mail/gmail/send/${currentInboxId}`, { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) { alert(data.detail || '발송 실패'); return; }
        alert('메일이 발송되었습니다!');
        loadInboxEmails();
        loadMailHistory();
    } catch (e) {
        alert('메일 발송 오류: ' + e.message);
    } finally {
        hideMailLoading();
    }
}

// --- 사이드바 탭 전환 ---
function switchMailSidebarTab(tab) {
    document.getElementById('mailSideTabInbox').classList.toggle('active', tab === 'inbox');
    document.getElementById('mailSideTabDocs').classList.toggle('active', tab === 'docs');
    document.getElementById('mailSideTabHistory').classList.toggle('active', tab === 'history');
    document.getElementById('mailSidePanelInbox').style.display = tab === 'inbox' ? '' : 'none';
    document.getElementById('mailSidePanelDocs').style.display = tab === 'docs' ? '' : 'none';
    document.getElementById('mailSidePanelHistory').style.display = tab === 'history' ? '' : 'none';
}

</script>
</body>
</html>
